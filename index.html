<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>SonicPocket AI</title>
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/morgandonor/morgandonor.github.io/refs/heads/main/icon.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/morgandonor/morgandonor.github.io/refs/heads/main/icon.png">

    <meta name="theme-color" content="#09090b" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="SonicPocket" />

    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>

    <style>
      @import url(https://fonts.googleapis.com/css?family=Google+Sans+Text);
      html {
        font-family: 'Google Sans Text', 'Google Sans', sans-serif;
        font-size: 14px;
        background: #09090b; /* Fixed dark background */
        color: white;
      }
      /* Custom scrollbar for webkit */
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #18181b; }
      ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #52525b; }
      /* Disable pull-to-refresh on mobile */
      body { overscroll-behavior-y: contain; }
      /* Safe area padding for iPhone X+ */
      .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
      .safe-area-pl { padding-left: env(safe-area-inset-left); }
      .safe-area-pr { padding-right: env(safe-area-inset-right); }
    </style>

    <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>

    <script type="importmap">{"imports":{"@modelcontextprotocol/sdk/":"https://esm.sh/@modelcontextprotocol/sdk/dist/esm/","https://esm.sh/@modelcontextprotocol/sdk@^1.11.0/es2022/":"https://esm.sh/@modelcontextprotocol/sdk@^1.11.0/es2022/dist/esm/","https://esm.sh/@modelcontextprotocol/sdk@^1.11.0/client/index?target=es2022":"https://esm.sh/@modelcontextprotocol/sdk@^1.11.0/dist/esm/client/index?target=es2022","https://esm.sh/@modelcontextprotocol/sdk@^1.11.0/types?target=es2022":"https://esm.sh/@modelcontextprotocol/sdk@^1.11.0/dist/esm/types?target=es2022","react":"https://aistudiocdn.com/react@^19.2.1","react-dom/":"https://aistudiocdn.com/react-dom@^19.2.1/","react/":"https://aistudiocdn.com/react@^19.2.1/","@/index":"data:application/javascript;base64,aW1wb3J0IHsganN4IGFzIF9qc3ggfSBmcm9tICJyZWFjdC9qc3gtcnVudGltZSI7CmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7CmltcG9ydCBSZWFjdERPTSBmcm9tICdyZWFjdC1kb20vY2xpZW50JzsKaW1wb3J0IEFwcCBmcm9tICdAL0FwcCc7CmNvbnN0IHJvb3RFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jvb3QnKTsKaWYgKCFyb290RWxlbWVudCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJDb3VsZCBub3QgZmluZCByb290IGVsZW1lbnQgdG8gbW91bnQgdG8iKTsKfQpjb25zdCByb290ID0gUmVhY3RET00uY3JlYXRlUm9vdChyb290RWxlbWVudCk7CnJvb3QucmVuZGVyKF9qc3goUmVhY3QuU3RyaWN0TW9kZSwgeyBjaGlsZHJlbjogX2pzeChBcHAsIHt9KSB9KSk7Cg==","@":"data:application/javascript;base64,aW1wb3J0IHsganN4IGFzIF9qc3ggfSBmcm9tICJyZWFjdC9qc3gtcnVudGltZSI7CmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7CmltcG9ydCBSZWFjdERPTSBmcm9tICdyZWFjdC1kb20vY2xpZW50JzsKaW1wb3J0IEFwcCBmcm9tICdAL0FwcCc7CmNvbnN0IHJvb3RFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jvb3QnKTsKaWYgKCFyb290RWxlbWVudCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJDb3VsZCBub3QgZmluZCByb290IGVsZW1lbnQgdG8gbW91bnQgdG8iKTsKfQpjb25zdCByb290ID0gUmVhY3RET00uY3JlYXRlUm9vdChyb290RWxlbWVudCk7CnJvb3QucmVuZGVyKF9qc3goUmVhY3QuU3RyaWN0TW9kZSwgeyBjaGlsZHJlbjogX2pzeChBcHAsIHt9KSB9KSk7Cg==","@/types":"data:application/javascript;base64,ZXhwb3J0IHZhciBBcHBTdGF0ZTsKKGZ1bmN0aW9uIChBcHBTdGF0ZSkgewogICAgQXBwU3RhdGVbIklETEUiXSA9ICJJRExFIjsKICAgIEFwcFN0YXRlWyJMT0FESU5HIl0gPSAiTE9BRElORyI7CiAgICBBcHBTdGF0ZVsiRURJVElORyJdID0gIkVESVRJTkciOwogICAgQXBwU3RhdGVbIlBST0NFU1NJTkciXSA9ICJQUk9DRVNTSU5HIjsKICAgIEFwcFN0YXRlWyJFUlJPUiJdID0gIkVSUk9SIjsKICAgIEFwcFN0YXRlWyJMSUJSQVJZIl0gPSAiTElCUkFSWSI7Cn0pKEFwcFN0YXRlIHx8IChBcHBTdGF0ZSA9IHt9KSk7CmV4cG9ydCB2YXIgVG9vbE1vZGU7CihmdW5jdGlvbiAoVG9vbE1vZGUpIHsKICAgIFRvb2xNb2RlWyJTRUxFQ1QiXSA9ICJTRUxFQ1QiOwogICAgVG9vbE1vZGVbIk1PVkUiXSA9ICJNT1ZFIjsKfSkoVG9vbE1vZGUgfHwgKFRvb2xNb2RlID0ge30pKTsK","@/constants":"data:application/javascript;base64,ZXhwb3J0IGNvbnN0IFRIRU1FX0NPTE9SID0gJyMwNmI2ZDQnOyAvLyBDeWFuLTUwMApleHBvcnQgY29uc3QgV0FWRUZPUk1fQ09MT1IgPSAnIzIyZDNlZSc7IC8vIEN5YW4tNDAwCmV4cG9ydCBjb25zdCBXQVZFRk9STV9CRyA9ICcjMTgxODFiJzsgLy8gWmluYy05MDAKZXhwb3J0IGNvbnN0IFNFTEVDVElPTl9DT0xPUiA9ICdyZ2JhKDYsIDE4MiwgMjEyLCAwLjMpJzsKZXhwb3J0IGNvbnN0IFBMQVlIRUFEX0NPTE9SID0gJyNlZjQ0NDQnOyAvLyBSZWQtNTAwCmV4cG9ydCBjb25zdCBERUZBVUxUX1NBTVBMRV9SQVRFID0gNDQxMDA7CmV4cG9ydCBjb25zdCBNQVhfWk9PTSA9IDMwMDsgLy8gcGl4ZWxzIHBlciBzZWNvbmQKZXhwb3J0IGNvbnN0IE1JTl9aT09NID0gMTA7CmV4cG9ydCBjb25zdCBERUZBVUxUX1pPT00gPSA1MDsKZXhwb3J0IGNvbnN0IERFRkFVTFRfTEFORV9IRUlHSFQgPSAxMjA7IC8vIEhlaWdodCBvZiBlYWNoIHRyYWNrIGxhbmUgaW4gcGl4ZWxzCmV4cG9ydCBjb25zdCBNSU5fTEFORV9IRUlHSFQgPSA2MDsgLy8gTWluaW11bSBjb21wYWN0ZWQgaGVpZ2h0CmV4cG9ydCBjb25zdCBTTkFQX1RIUkVTSE9MRF9QWCA9IDE1OyAvLyBEaXN0YW5jZSBpbiBwaXhlbHMgdG8gdHJpZ2dlciBzbmFwcGluZwovLyBJbnRlcmFjdGlvbiBDb25zdGFudHMKZXhwb3J0IGNvbnN0IExPTkdfUFJFU1NfRFVSQVRJT04gPSAzMDA7IC8vIG1zIHRvIGhvbGQgYmVmb3JlIGRyYWcgc3RhcnRzCmV4cG9ydCBjb25zdCBEUkFHX1RIUkVTSE9MRF9QWCA9IDE1OyAvLyBJbmNyZWFzZWQgdG8gMTVweCB0byBwcmV2ZW50IGFjY2lkZW50YWwgc2Nyb2xsIGRldGVjdGlvbiBkdXJpbmcgaG9sZAovLyBFeHRlbmRlZCBQYWxldHRlIGZvciBNdWx0aS1sYXllciB2aXN1YWxpemF0aW9uCmV4cG9ydCBjb25zdCBUUkFDS19DT0xPUlMgPSBbCiAgICAnIzIyZDNlZScsIC8vIEN5YW4tNDAwCiAgICAnIzgxOGNmOCcsIC8vIEluZGlnby00MDAKICAgICcjZTg3OWY5JywgLy8gRnVjaHNpYS00MDAKICAgICcjZjQ3MmI2JywgLy8gUGluay00MDAKICAgICcjZmI3MTg1JywgLy8gUm9zZS00MDAKICAgICcjMzRkMzk5JywgLy8gRW1lcmFsZC00MDAKICAgICcjZmJiZjI0JywgLy8gQW1iZXItNDAwCiAgICAnI2E3OGJmYScsIC8vIFZpb2xldC00MDAKICAgICcjMmRkNGJmJywgLy8gVGVhbC00MDAKICAgICcjNjBhNWZhJywgLy8gQmx1ZS00MDAKXTsKZXhwb3J0IGNvbnN0IEJFQVRfUEFUVEVSTlMgPSB7CiAgICAvLyAxNiBzdGVwcy4gMSA9IEtpY2ssIDIgPSBTbmFyZSwgMyA9IEhpSGF0CiAgICAnUm9jayc6IFtbMSwgMCwgMywgMCwgMiwgMCwgMywgMCwgMSwgMCwgMywgMSwgMiwgMCwgMywgMF1dLAogICAgJ0hpcEhvcCc6IFtbMSwgMCwgMywgMCwgMiwgMCwgMywgMSwgMCwgMSwgMywgMCwgMiwgMCwgMywgMF1dLAogICAgJ1RlY2hubyc6IFtbMSwgMywgMCwgMywgMSwgMywgMCwgMywgMSwgMywgMCwgMywgMSwgMywgMCwgM11dLAogICAgJ01ldHJvbm9tZSc6IFtbNCwgMCwgMCwgMCwgNSwgMCwgMCwgMCwgNSwgMCwgMCwgMCwgNSwgMCwgMCwgMF1dIC8vIDQ9SGlnaCBUaWNrLCA1PUxvdyBUaWNrCn07Cg==","@/services/audioUtils":"data:application/javascript;base64,aW1wb3J0IHsgREVGQVVMVF9TQU1QTEVfUkFURSwgQkVBVF9QQVRURVJOUyB9IGZyb20gJ0AvY29uc3RhbnRzJzsKbGV0IGF1ZGlvQ29udGV4dCA9IG51bGw7CmV4cG9ydCBjb25zdCBnZXRBdWRpb0NvbnRleHQgPSAoKSA9PiB7CiAgICBpZiAoIWF1ZGlvQ29udGV4dCkgewogICAgICAgIGNvbnN0IEN0eCA9IHdpbmRvdy5BdWRpb0NvbnRleHQgfHwgd2luZG93LndlYmtpdEF1ZGlvQ29udGV4dDsKICAgICAgICB0cnkgewogICAgICAgICAgICAvLyBBdHRlbXB0IHRvIHN1cHBvcnQgaGlnaCBzYW1wbGUgcmF0ZXMgdXAgdG8gMTkya0h6CiAgICAgICAgICAgIGF1ZGlvQ29udGV4dCA9IG5ldyBDdHgoewogICAgICAgICAgICAgICAgc2FtcGxlUmF0ZTogMTkyMDAwLAogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCIxOTJrSHogc2FtcGxlIHJhdGUgbm90IHN1cHBvcnRlZCwgZmFsbGluZyBiYWNrIHRvIHN5c3RlbSBkZWZhdWx0LiIpOwogICAgICAgICAgICBhdWRpb0NvbnRleHQgPSBuZXcgQ3R4KCk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIGF1ZGlvQ29udGV4dDsKfTsKZXhwb3J0IGNvbnN0IGRlY29kZUF1ZGlvRGF0YSA9IGFzeW5jIChhcnJheUJ1ZmZlcikgPT4gewogICAgY29uc3QgY3R4ID0gZ2V0QXVkaW9Db250ZXh0KCk7CiAgICByZXR1cm4gYXdhaXQgY3R4LmRlY29kZUF1ZGlvRGF0YShhcnJheUJ1ZmZlcik7Cn07CmV4cG9ydCBjb25zdCBjcmVhdGVFbXB0eUJ1ZmZlciA9IChjdHgsIHNlY29uZHMpID0+IHsKICAgIHJldHVybiBjdHguY3JlYXRlQnVmZmVyKDIsIGN0eC5zYW1wbGVSYXRlICogc2Vjb25kcywgY3R4LnNhbXBsZVJhdGUpOwp9OwovLyAtLS0gUGxheWJhY2sgVXRpbGl0eSBmb3IgUHJldmlld3MgLS0tCmxldCBjdXJyZW50UHJldmlld1NvdXJjZSA9IG51bGw7CmV4cG9ydCBjb25zdCBwbGF5QnVmZmVyID0gKGJ1ZmZlcikgPT4gewogICAgY29uc3QgY3R4ID0gZ2V0QXVkaW9Db250ZXh0KCk7CiAgICBpZiAoY3VycmVudFByZXZpZXdTb3VyY2UpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBjdXJyZW50UHJldmlld1NvdXJjZS5zdG9wKCk7CiAgICAgICAgfQogICAgICAgIGNhdGNoIChlKSB7IH0KICAgIH0KICAgIGNvbnN0IHNvdXJjZSA9IGN0eC5jcmVhdGVCdWZmZXJTb3VyY2UoKTsKICAgIHNvdXJjZS5idWZmZXIgPSBidWZmZXI7CiAgICBzb3VyY2UuY29ubmVjdChjdHguZGVzdGluYXRpb24pOwogICAgc291cmNlLnN0YXJ0KCk7CiAgICBjdXJyZW50UHJldmlld1NvdXJjZSA9IHNvdXJjZTsKfTsKLy8gLS0tIFRpbWUgU3RyZXRjaGluZyAoR3JhbnVsYXIgU3ludGhlc2lzKSAtLS0KLyoqCiAqIENoYW5nZXMgZHVyYXRpb24gV0lUSE9VVCBjaGFuZ2luZyBwaXRjaCB1c2luZyBhIHNpbXBsaWZpZWQgT0xBIChPdmVybGFwLUFkZCkgR3JhbnVsYXIgbWV0aG9kLgogKiBAcGFyYW0gYnVmZmVyIElucHV0IGJ1ZmZlcgogKiBAcGFyYW0gcGxheWJhY2tSYXRlIFRhcmdldCByYXRlICgwLjUgPSBoYWxmIHNwZWVkL2RvdWJsZSBkdXJhdGlvbiwgMi4wID0gZG91YmxlIHNwZWVkL2hhbGYgZHVyYXRpb24pCiAqLwpleHBvcnQgY29uc3QgZ3JhbnVsYXJUaW1lU3RyZXRjaCA9IGFzeW5jIChidWZmZXIsIHBsYXliYWNrUmF0ZSkgPT4gewogICAgLy8gSWYgcmF0ZSBpcyAxLCByZXR1cm4gY29weQogICAgaWYgKHBsYXliYWNrUmF0ZSA9PT0gMS4wKQogICAgICAgIHJldHVybiBidWZmZXI7CiAgICBjb25zdCBjaGFubmVscyA9IGJ1ZmZlci5udW1iZXJPZkNoYW5uZWxzOwogICAgY29uc3QgaW5wdXRMZW4gPSBidWZmZXIubGVuZ3RoOwogICAgLy8gTmV3IGxlbmd0aCBpcyBpbnZlcnNlIG9mIHJhdGUuICgyeCBzcGVlZCA9IDAuNXggbGVuZ3RoKQogICAgY29uc3Qgb3V0cHV0TGVuID0gTWF0aC5mbG9vcihpbnB1dExlbiAvIHBsYXliYWNrUmF0ZSk7CiAgICBjb25zdCBzYW1wbGVSYXRlID0gYnVmZmVyLnNhbXBsZVJhdGU7CiAgICBjb25zdCBjdHggPSBuZXcgT2ZmbGluZUF1ZGlvQ29udGV4dChjaGFubmVscywgb3V0cHV0TGVuLCBzYW1wbGVSYXRlKTsKICAgIGNvbnN0IG91dHB1dEJ1ZmZlciA9IGN0eC5jcmVhdGVCdWZmZXIoY2hhbm5lbHMsIG91dHB1dExlbiwgc2FtcGxlUmF0ZSk7CiAgICAvLyBHcmFudWxhciBQYXJhbWV0ZXJzCiAgICBjb25zdCBncmFpblNpemUgPSBNYXRoLmZsb29yKHNhbXBsZVJhdGUgKiAwLjA4KTsgLy8gODBtcyBncmFpbnMKICAgIGNvbnN0IG92ZXJsYXAgPSBNYXRoLmZsb29yKGdyYWluU2l6ZSAqIDAuNSk7IC8vIDUwJSBvdmVybGFwCiAgICAvLyBXZSBtb3ZlIHRocm91Z2ggdGhlIElOUFVUIGF0ICdwbGF5YmFja1JhdGUnIHNwZWVkIHJlbGF0aXZlIHRvIG91dHB1dAogICAgLy8gQnV0IHdlIGNvcHkgJ2dyYWluU2l6ZScgY2h1bmtzIDE6MSB0byBwcmVzZXJ2ZSBwaXRjaC4KICAgIGZvciAobGV0IGMgPSAwOyBjIDwgY2hhbm5lbHM7IGMrKykgewogICAgICAgIGNvbnN0IGlucHV0RGF0YSA9IGJ1ZmZlci5nZXRDaGFubmVsRGF0YShjKTsKICAgICAgICBjb25zdCBvdXRwdXREYXRhID0gb3V0cHV0QnVmZmVyLmdldENoYW5uZWxEYXRhKGMpOwogICAgICAgIGxldCBpbnB1dE9mZnNldCA9IDA7CiAgICAgICAgbGV0IG91dHB1dE9mZnNldCA9IDA7CiAgICAgICAgLy8gV2hpbGUgd2UgaGF2ZSByb29tIGluIG91dHB1dCBhbmQgaW5wdXQKICAgICAgICB3aGlsZSAob3V0cHV0T2Zmc2V0ICsgZ3JhaW5TaXplIDwgb3V0cHV0TGVuICYmIGlucHV0T2Zmc2V0ICsgZ3JhaW5TaXplIDwgaW5wdXRMZW4pIHsKICAgICAgICAgICAgLy8gMS4gRmFkZSBPdXQgLyBJbiBXaW5kb3dpbmcgKEhhbm5pbmctaXNoKQogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGdyYWluU2l6ZTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBpbnB1dElkeCA9IE1hdGguZmxvb3IoaW5wdXRPZmZzZXQpICsgaTsKICAgICAgICAgICAgICAgIGNvbnN0IG91dHB1dElkeCA9IG91dHB1dE9mZnNldCArIGk7CiAgICAgICAgICAgICAgICBpZiAoaW5wdXRJZHggPj0gaW5wdXRMZW4gfHwgb3V0cHV0SWR4ID49IG91dHB1dExlbikKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIC8vIFNpbXBsZSBsaW5lYXIgY3Jvc3NmYWRlIHdpbmRvdyBmb3IgdGhlIG92ZXJsYXAgcmVnaW9uCiAgICAgICAgICAgICAgICAvLyBUbyBibGVuZCBzdHJpY3RseSwgd2UganVzdCBhZGQuIEEgcmVhbCBpbXBsZW1lbnRhdGlvbiB1c2VzIHByb3BlciB3aW5kb3cgZnVuY3Rpb25zLgogICAgICAgICAgICAgICAgLy8gSGVyZSB3ZSBzaW1wbHkgY29weSB0aGUgZ3JhaW4uIFRoZSBqaXR0ZXIgY29tZXMgZnJvbSB0aGUgcGhhc2UgZGlzY29udGludWl0eS4KICAgICAgICAgICAgICAgIC8vIFdlJ2xsIGRvIGEgc2ltcGxlIE9MQS4KICAgICAgICAgICAgICAgIGxldCBnYWluID0gMS4wOwogICAgICAgICAgICAgICAgaWYgKGkgPCBvdmVybGFwKSB7CiAgICAgICAgICAgICAgICAgICAgZ2FpbiA9IGkgLyBvdmVybGFwOyAvLyBGYWRlIEluCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChpID4gZ3JhaW5TaXplIC0gb3ZlcmxhcCkgewogICAgICAgICAgICAgICAgICAgIGdhaW4gPSAoZ3JhaW5TaXplIC0gaSkgLyBvdmVybGFwOyAvLyBGYWRlIE91dAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gQWRkIHRvIG91dHB1dCAoT0xBKQogICAgICAgICAgICAgICAgb3V0cHV0RGF0YVtvdXRwdXRJZHhdICs9IGlucHV0RGF0YVtpbnB1dElkeF0gKiBnYWluOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE1vdmUgaGVhZHMKICAgICAgICAgICAgLy8gT3V0cHV0IG1vdmVzIGJ5IHRoZSBub24tb3ZlcmxhcHBlZCBhbW91bnQgKGhvcCBzaXplKQogICAgICAgICAgICBjb25zdCBvdXRwdXRIb3AgPSBncmFpblNpemUgLSBvdmVybGFwOwogICAgICAgICAgICBvdXRwdXRPZmZzZXQgKz0gb3V0cHV0SG9wOwogICAgICAgICAgICAvLyBJbnB1dCBtb3ZlcyBieSAoaG9wIHNpemUgKiByYXRlKSB0byBhY2hpZXZlIHRpbWUgc3RyZXRjaAogICAgICAgICAgICBpbnB1dE9mZnNldCArPSBvdXRwdXRIb3AgKiBwbGF5YmFja1JhdGU7CiAgICAgICAgfQogICAgfQogICAgLy8gTm9ybWFsaXplIG91dHB1dCB0byBwcmV2ZW50IGNsaXBwaW5nIGZyb20gT0xBCiAgICByZXR1cm4gbm9ybWFsaXplQnVmZmVyKG91dHB1dEJ1ZmZlcik7Cn07Ci8vIC0tLSBCUE0gRGV0ZWN0aW9uIC0tLQpleHBvcnQgY29uc3QgZGV0ZWN0QlBNID0gYXN5bmMgKGJ1ZmZlcikgPT4gewogICAgdHJ5IHsKICAgICAgICBsZXQgYW5hbHlzaXNCdWZmZXIgPSBidWZmZXI7CiAgICAgICAgaWYgKGJ1ZmZlci5kdXJhdGlvbiA+IDQwKSB7CiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gTWF0aC5mbG9vcihidWZmZXIuZHVyYXRpb24gLyAyKSAtIDIwOwogICAgICAgICAgICBjb25zdCBlbmQgPSBzdGFydCArIDQwOwogICAgICAgICAgICBhbmFseXNpc0J1ZmZlciA9IHRyaW1CdWZmZXIoYnVmZmVyLCBzdGFydCwgZW5kKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb2ZmbGluZUN0eCA9IG5ldyBPZmZsaW5lQXVkaW9Db250ZXh0KDEsIGFuYWx5c2lzQnVmZmVyLmxlbmd0aCwgYW5hbHlzaXNCdWZmZXIuc2FtcGxlUmF0ZSk7CiAgICAgICAgY29uc3Qgc291cmNlID0gb2ZmbGluZUN0eS5jcmVhdGVCdWZmZXJTb3VyY2UoKTsKICAgICAgICBzb3VyY2UuYnVmZmVyID0gYW5hbHlzaXNCdWZmZXI7CiAgICAgICAgY29uc3QgbG93cGFzcyA9IG9mZmxpbmVDdHguY3JlYXRlQmlxdWFkRmlsdGVyKCk7CiAgICAgICAgbG93cGFzcy50eXBlID0gImxvd3Bhc3MiOwogICAgICAgIGxvd3Bhc3MuZnJlcXVlbmN5LnZhbHVlID0gNDAwOwogICAgICAgIGxvd3Bhc3MuUS52YWx1ZSA9IDE7CiAgICAgICAgY29uc3QgaGlnaHBhc3MgPSBvZmZsaW5lQ3R4LmNyZWF0ZUJpcXVhZEZpbHRlcigpOwogICAgICAgIGhpZ2hwYXNzLnR5cGUgPSAiaGlnaHBhc3MiOwogICAgICAgIGhpZ2hwYXNzLmZyZXF1ZW5jeS52YWx1ZSA9IDcwOwogICAgICAgIGhpZ2hwYXNzLlEudmFsdWUgPSAxOwogICAgICAgIHNvdXJjZS5jb25uZWN0KGxvd3Bhc3MpOwogICAgICAgIGxvd3Bhc3MuY29ubmVjdChoaWdocGFzcyk7CiAgICAgICAgaGlnaHBhc3MuY29ubmVjdChvZmZsaW5lQ3R4LmRlc3RpbmF0aW9uKTsKICAgICAgICBzb3VyY2Uuc3RhcnQoMCk7CiAgICAgICAgY29uc3QgcmVuZGVyZWQgPSBhd2FpdCBvZmZsaW5lQ3R4LnN0YXJ0UmVuZGVyaW5nKCk7CiAgICAgICAgY29uc3QgZGF0YSA9IHJlbmRlcmVkLmdldENoYW5uZWxEYXRhKDApOwogICAgICAgIGNvbnN0IHdpbmRvd1NpemUgPSBNYXRoLmZsb29yKGFuYWx5c2lzQnVmZmVyLnNhbXBsZVJhdGUgKiAwLjAwNSk7CiAgICAgICAgY29uc3QgZW5lcmd5UHJvZmlsZSA9IFtdOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkgKz0gd2luZG93U2l6ZSkgewogICAgICAgICAgICBsZXQgc3VtID0gMDsKICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB3aW5kb3dTaXplICYmIGkgKyBqIDwgZGF0YS5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgc3VtICs9IGRhdGFbaSArIGpdICogZGF0YVtpICsgal07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZW5lcmd5UHJvZmlsZS5wdXNoKE1hdGguc3FydChzdW0gLyB3aW5kb3dTaXplKSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG9uc2V0UHJvZmlsZSA9IFtdOwogICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgZW5lcmd5UHJvZmlsZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCBkaWZmID0gZW5lcmd5UHJvZmlsZVtpXSAtIGVuZXJneVByb2ZpbGVbaSAtIDFdOwogICAgICAgICAgICBvbnNldFByb2ZpbGUucHVzaChNYXRoLm1heChkaWZmLCAwKSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG1pbkJQTSA9IDYwOwogICAgICAgIGNvbnN0IG1heEJQTSA9IDE4MDsKICAgICAgICBjb25zdCBtaW5MYWcgPSBNYXRoLmZsb29yKDYwIC8gKG1heEJQTSAqIDAuMDA1KSk7CiAgICAgICAgY29uc3QgbWF4TGFnID0gTWF0aC5jZWlsKDYwIC8gKG1pbkJQTSAqIDAuMDA1KSk7CiAgICAgICAgY29uc3QgY29ycmVsYXRpb25zID0gW107CiAgICAgICAgY29uc3Qgc2VhcmNoTGVuID0gTWF0aC5taW4ob25zZXRQcm9maWxlLmxlbmd0aCwgMzAwMCk7CiAgICAgICAgZm9yIChsZXQgbGFnID0gbWluTGFnOyBsYWcgPD0gbWF4TGFnOyBsYWcrKykgewogICAgICAgICAgICBsZXQgY3VycmVudENvcnJlbGF0aW9uID0gMDsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZWFyY2hMZW4gLSBsYWc7IGkrKykgewogICAgICAgICAgICAgICAgY3VycmVudENvcnJlbGF0aW9uICs9IG9uc2V0UHJvZmlsZVtpXSAqIG9uc2V0UHJvZmlsZVtpICsgbGFnXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb3JyZWxhdGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICBicG06IDYwIC8gKGxhZyAqIDAuMDA1KSwKICAgICAgICAgICAgICAgIHN0cmVuZ3RoOiBjdXJyZW50Q29ycmVsYXRpb24KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGNvcnJlbGF0aW9ucy5zb3J0KChhLCBiKSA9PiBiLnN0cmVuZ3RoIC0gYS5zdHJlbmd0aCk7CiAgICAgICAgaWYgKGNvcnJlbGF0aW9ucy5sZW5ndGggPT09IDApCiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIGNvbnN0IHRvcENhbmRpZGF0ZXMgPSBjb3JyZWxhdGlvbnMuc2xpY2UoMCwgNSk7CiAgICAgICAgbGV0IGNob3NlbkJQTSA9IHRvcENhbmRpZGF0ZXNbMF0uYnBtOwogICAgICAgIGNvbnN0IG1heFN0cmVuZ3RoID0gdG9wQ2FuZGlkYXRlc1swXS5zdHJlbmd0aDsKICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IHRvcENhbmRpZGF0ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgY2FuZGlkYXRlID0gdG9wQ2FuZGlkYXRlc1tpXTsKICAgICAgICAgICAgaWYgKGNhbmRpZGF0ZS5zdHJlbmd0aCA+IG1heFN0cmVuZ3RoICogMC43NSkgewogICAgICAgICAgICAgICAgY29uc3Qgd2lubmVySXNFeHRyZW1lID0gY2hvc2VuQlBNIDwgOTAgfHwgY2hvc2VuQlBNID4gMTYwOwogICAgICAgICAgICAgICAgY29uc3QgY2FuZGlkYXRlSXNOb3JtYWwgPSBjYW5kaWRhdGUuYnBtID49IDkwICYmIGNhbmRpZGF0ZS5icG0gPD0gMTYwOwogICAgICAgICAgICAgICAgaWYgKHdpbm5lcklzRXh0cmVtZSAmJiBjYW5kaWRhdGVJc05vcm1hbCkgewogICAgICAgICAgICAgICAgICAgIGNob3NlbkJQTSA9IGNhbmRpZGF0ZS5icG07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoY2FuZGlkYXRlLmJwbSAtIDIgKiBjaG9zZW5CUE0pIDwgNSkgewogICAgICAgICAgICAgICAgICAgIGNob3NlbkJQTSA9IGNhbmRpZGF0ZS5icG07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQoY2hvc2VuQlBNKTsKICAgIH0KICAgIGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiQlBNIERldGVjdGlvbiBFcnJvciIsIGUpOwogICAgICAgIHJldHVybiAwOwogICAgfQp9OwovLyAtLS0gUHJldmlldyBHZW5lcmF0aW9uIC0tLQpleHBvcnQgY29uc3QgZ2VuZXJhdGVQcm9qZWN0UHJldmlldyA9ICh0cmFja3MsIHdpZHRoLCBoZWlnaHQpID0+IHsKICAgIGNvbnN0IGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgY2FudmFzLndpZHRoID0gd2lkdGg7CiAgICBjYW52YXMuaGVpZ2h0ID0gaGVpZ2h0OwogICAgY29uc3QgY3R4ID0gY2FudmFzLmdldENvbnRleHQoJzJkJyk7CiAgICBpZiAoIWN0eCkKICAgICAgICByZXR1cm4gJyc7CiAgICBjdHguZmlsbFN0eWxlID0gJyMxODE4MWInOwogICAgY3R4LmZpbGxSZWN0KDAsIDAsIHdpZHRoLCBoZWlnaHQpOwogICAgaWYgKHRyYWNrcy5sZW5ndGggPT09IDApCiAgICAgICAgcmV0dXJuIGNhbnZhcy50b0RhdGFVUkwoKTsKICAgIGNvbnN0IG1heER1ciA9IE1hdGgubWF4KC4uLnRyYWNrcy5tYXAodCA9PiB0LnN0YXJ0VGltZSArIHQuZHVyYXRpb24pKTsKICAgIGNvbnN0IHNjYWxlWCA9IHdpZHRoIC8gKG1heER1ciB8fCAxKTsKICAgIHRyYWNrcy5mb3JFYWNoKHRyYWNrID0+IHsKICAgICAgICBjb25zdCB4ID0gdHJhY2suc3RhcnRUaW1lICogc2NhbGVYOwogICAgICAgIGNvbnN0IHcgPSBNYXRoLm1heCgyLCB0cmFjay5kdXJhdGlvbiAqIHNjYWxlWCk7CiAgICAgICAgY29uc3QgbGFuZUggPSBoZWlnaHQgLyA1OwogICAgICAgIGNvbnN0IHkgPSAodHJhY2subGFuZSAlIDUpICogbGFuZUggKyAyOwogICAgICAgIGNvbnN0IGggPSBsYW5lSCAtIDQ7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IHRyYWNrLmNvbG9yOwogICAgICAgIGN0eC5maWxsUmVjdCh4LCB5LCB3LCBoKTsKICAgIH0pOwogICAgcmV0dXJuIGNhbnZhcy50b0RhdGFVUkwoJ2ltYWdlL3BuZycpOwp9OwovLyAtLS0gT2ZmbGluZSBQcm9jZXNzaW5nIFV0aWxpdGllcyAtLS0KZXhwb3J0IGNvbnN0IGFwcGx5RmFkZSA9IGFzeW5jIChidWZmZXIsIHR5cGUsIGR1cmF0aW9uKSA9PiB7CiAgICBjb25zdCBjdHggPSBuZXcgT2ZmbGluZUF1ZGlvQ29udGV4dChidWZmZXIubnVtYmVyT2ZDaGFubmVscywgYnVmZmVyLmxlbmd0aCwgYnVmZmVyLnNhbXBsZVJhdGUpOwogICAgY29uc3Qgc291cmNlID0gY3R4LmNyZWF0ZUJ1ZmZlclNvdXJjZSgpOwogICAgc291cmNlLmJ1ZmZlciA9IGJ1ZmZlcjsKICAgIGNvbnN0IGdhaW4gPSBjdHguY3JlYXRlR2FpbigpOwogICAgc291cmNlLmNvbm5lY3QoZ2Fpbik7CiAgICBnYWluLmNvbm5lY3QoY3R4LmRlc3RpbmF0aW9uKTsKICAgIGNvbnN0IGZhZGVEdXIgPSBNYXRoLm1pbihkdXJhdGlvbiwgYnVmZmVyLmR1cmF0aW9uKTsKICAgIGlmICh0eXBlID09PSAnaW4nKSB7CiAgICAgICAgZ2Fpbi5nYWluLnNldFZhbHVlQXRUaW1lKDAsIDApOwogICAgICAgIGdhaW4uZ2Fpbi5saW5lYXJSYW1wVG9WYWx1ZUF0VGltZSgxLCBmYWRlRHVyKTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIGdhaW4uZ2Fpbi5zZXRWYWx1ZUF0VGltZSgxLCBidWZmZXIuZHVyYXRpb24gLSBmYWRlRHVyKTsKICAgICAgICBnYWluLmdhaW4ubGluZWFyUmFtcFRvVmFsdWVBdFRpbWUoMCwgYnVmZmVyLmR1cmF0aW9uKTsKICAgIH0KICAgIHNvdXJjZS5zdGFydCgpOwogICAgcmV0dXJuIGF3YWl0IGN0eC5zdGFydFJlbmRlcmluZygpOwp9OwpleHBvcnQgY29uc3QgbWVyZ2VCdWZmZXJzID0gYXN5bmMgKGxlZnQsIHJpZ2h0LCBvdmVybGFwRHVyYXRpb24pID0+IHsKICAgIGNvbnN0IGNoYW5uZWxzID0gTWF0aC5tYXgobGVmdC5udW1iZXJPZkNoYW5uZWxzLCByaWdodC5udW1iZXJPZkNoYW5uZWxzKTsKICAgIGNvbnN0IHNhbXBsZVJhdGUgPSBsZWZ0LnNhbXBsZVJhdGU7CiAgICBjb25zdCB0b3RhbER1cmF0aW9uID0gbGVmdC5kdXJhdGlvbiArIHJpZ2h0LmR1cmF0aW9uIC0gb3ZlcmxhcER1cmF0aW9uOwogICAgY29uc3QgbGVuZ3RoID0gTWF0aC5jZWlsKHRvdGFsRHVyYXRpb24gKiBzYW1wbGVSYXRlKTsKICAgIGNvbnN0IGN0eCA9IG5ldyBPZmZsaW5lQXVkaW9Db250ZXh0KGNoYW5uZWxzLCBsZW5ndGgsIHNhbXBsZVJhdGUpOwogICAgY29uc3Qgc3JjTGVmdCA9IGN0eC5jcmVhdGVCdWZmZXJTb3VyY2UoKTsKICAgIHNyY0xlZnQuYnVmZmVyID0gbGVmdDsKICAgIGNvbnN0IGdhaW5MZWZ0ID0gY3R4LmNyZWF0ZUdhaW4oKTsKICAgIHNyY0xlZnQuY29ubmVjdChnYWluTGVmdCk7CiAgICBnYWluTGVmdC5jb25uZWN0KGN0eC5kZXN0aW5hdGlvbik7CiAgICBjb25zdCBzcmNSaWdodCA9IGN0eC5jcmVhdGVCdWZmZXJTb3VyY2UoKTsKICAgIHNyY1JpZ2h0LmJ1ZmZlciA9IHJpZ2h0OwogICAgY29uc3QgZ2FpblJpZ2h0ID0gY3R4LmNyZWF0ZUdhaW4oKTsKICAgIHNyY1JpZ2h0LmNvbm5lY3QoZ2FpblJpZ2h0KTsKICAgIGdhaW5SaWdodC5jb25uZWN0KGN0eC5kZXN0aW5hdGlvbik7CiAgICBjb25zdCBvdmVybGFwU3RhcnQgPSBsZWZ0LmR1cmF0aW9uIC0gb3ZlcmxhcER1cmF0aW9uOwogICAgZ2FpbkxlZnQuZ2Fpbi5zZXRWYWx1ZUF0VGltZSgxLCBvdmVybGFwU3RhcnQpOwogICAgZ2FpbkxlZnQuZ2Fpbi5saW5lYXJSYW1wVG9WYWx1ZUF0VGltZSgwLCBsZWZ0LmR1cmF0aW9uKTsKICAgIGNvbnN0IHJpZ2h0U3RhcnRUaW1lID0gb3ZlcmxhcFN0YXJ0OwogICAgZ2FpblJpZ2h0LmdhaW4uc2V0VmFsdWVBdFRpbWUoMCwgcmlnaHRTdGFydFRpbWUpOwogICAgZ2FpblJpZ2h0LmdhaW4ubGluZWFyUmFtcFRvVmFsdWVBdFRpbWUoMSwgcmlnaHRTdGFydFRpbWUgKyBvdmVybGFwRHVyYXRpb24pOwogICAgc3JjTGVmdC5zdGFydCgwKTsKICAgIHNyY1JpZ2h0LnN0YXJ0KHJpZ2h0U3RhcnRUaW1lKTsKICAgIHJldHVybiBhd2FpdCBjdHguc3RhcnRSZW5kZXJpbmcoKTsKfTsKZXhwb3J0IGNvbnN0IGNoYW5nZVNwZWVkID0gYXN5bmMgKGJ1ZmZlciwgcGxheWJhY2tSYXRlLCBwcmVzZXJ2ZVBpdGNoID0gZmFsc2UpID0+IHsKICAgIGlmIChwcmVzZXJ2ZVBpdGNoKSB7CiAgICAgICAgLy8gVXNlIEdyYW51bGFyIFRpbWUgU3RyZXRjaAogICAgICAgIHJldHVybiBhd2FpdCBncmFudWxhclRpbWVTdHJldGNoKGJ1ZmZlciwgcGxheWJhY2tSYXRlKTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIC8vIFN0YW5kYXJkIFJlc2FtcGxpbmcgKENoYW5nZXMgUGl0Y2gpCiAgICAgICAgY29uc3QgbmV3RHVyYXRpb24gPSBidWZmZXIuZHVyYXRpb24gLyBwbGF5YmFja1JhdGU7CiAgICAgICAgY29uc3QgY3R4ID0gbmV3IE9mZmxpbmVBdWRpb0NvbnRleHQoYnVmZmVyLm51bWJlck9mQ2hhbm5lbHMsIE1hdGguY2VpbChuZXdEdXJhdGlvbiAqIGJ1ZmZlci5zYW1wbGVSYXRlKSwgYnVmZmVyLnNhbXBsZVJhdGUpOwogICAgICAgIGNvbnN0IHNvdXJjZSA9IGN0eC5jcmVhdGVCdWZmZXJTb3VyY2UoKTsKICAgICAgICBzb3VyY2UuYnVmZmVyID0gYnVmZmVyOwogICAgICAgIHNvdXJjZS5wbGF5YmFja1JhdGUudmFsdWUgPSBwbGF5YmFja1JhdGU7CiAgICAgICAgc291cmNlLmNvbm5lY3QoY3R4LmRlc3RpbmF0aW9uKTsKICAgICAgICBzb3VyY2Uuc3RhcnQoKTsKICAgICAgICByZXR1cm4gYXdhaXQgY3R4LnN0YXJ0UmVuZGVyaW5nKCk7CiAgICB9Cn07CmV4cG9ydCBjb25zdCByZXZlcnNlQnVmZmVyID0gKGJ1ZmZlcikgPT4gewogICAgY29uc3QgY3R4ID0gZ2V0QXVkaW9Db250ZXh0KCk7CiAgICBjb25zdCBuZXdCdWZmZXIgPSBjdHguY3JlYXRlQnVmZmVyKGJ1ZmZlci5udW1iZXJPZkNoYW5uZWxzLCBidWZmZXIubGVuZ3RoLCBidWZmZXIuc2FtcGxlUmF0ZSk7CiAgICBmb3IgKGxldCBjID0gMDsgYyA8IGJ1ZmZlci5udW1iZXJPZkNoYW5uZWxzOyBjKyspIHsKICAgICAgICBjb25zdCBvbGREYXRhID0gYnVmZmVyLmdldENoYW5uZWxEYXRhKGMpOwogICAgICAgIGNvbnN0IG5ld0RhdGEgPSBuZXdCdWZmZXIuZ2V0Q2hhbm5lbERhdGEoYyk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuZXdEYXRhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIG5ld0RhdGFbaV0gPSBvbGREYXRhW2J1ZmZlci5sZW5ndGggLSAxIC0gaV07CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIG5ld0J1ZmZlcjsKfTsKZXhwb3J0IGNvbnN0IG5vcm1hbGl6ZUJ1ZmZlciA9IChidWZmZXIpID0+IHsKICAgIGxldCBtYXggPSAwOwogICAgZm9yIChsZXQgYyA9IDA7IGMgPCBidWZmZXIubnVtYmVyT2ZDaGFubmVsczsgYysrKSB7CiAgICAgICAgY29uc3QgZGF0YSA9IGJ1ZmZlci5nZXRDaGFubmVsRGF0YShjKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKE1hdGguYWJzKGRhdGFbaV0pID4gbWF4KQogICAgICAgICAgICAgICAgbWF4ID0gTWF0aC5hYnMoZGF0YVtpXSk7CiAgICAgICAgfQogICAgfQogICAgaWYgKG1heCA9PT0gMCkK
